---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Sidebar from '../components/Sidebar.astro';
import BaseHead from '../components/BaseHead.astro';
import Papa from 'papaparse';

const { title } = Astro.props;

// Fetch bike tours from Google Sheets (same sheet as homepage)
const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSueJxrlH6WKPNcw8xsvlvgWYnv-qUB6fXnViiZcCS4UfYU1HoI-VagXnv6Tu-5_07OmsTdO8MIsrGo/pub?gid=0&single=true&output=csv');
const csvText = await response.text();

// Parse CSV to JSON
const { data: tours } = Papa.parse(csvText, { header: true });

const formatRupiah = (number: number) => {
  return new Intl.NumberFormat('id-ID', {
    style: 'currency',
    currency: 'IDR',
    minimumFractionDigits: 0
  }).format(number);
}

const driveImager = (file_id: string) => {
  return 'https://lh3.googleusercontent.com/u/0/d/' + file_id + '=w4000';
}
---
<html>
  <head>
    <BaseHead title={title} description={'description'} />
  </head>
  <body>
    <Header />
    <section class="tours-page">
      <header class="tours-header">
        <h2>Jelajahi Ponjong dengan Sepeda</h2>
        <p>
          Jelajahi eksotisme bukit karst, hijaunya persawahan, dan hangatnya suasana pedesaan Ponjong.
        </p>
        <p>
          Nikmati rute eksklusif yang dikurasi langsung oleh warga lokal demi pengalaman yang tak terlupakan.
        </p>
        <p>
          Temukan kedamaian dan interaksi tulus dengan penduduk desa di sepanjang perjalanan Anda.
        </p>
      </header>

      <div class="tour-section" id="tour-section">
        <h3 class="tour-section-title">Paket Tour Pilihan</h3>

        <div class="tour-scroll-container">
          {tours.map((tour: any, i: number) => (
            <div class="tour-card" data-tour-index={i}>
              <div
                class="card-image"
                style={`background-image: url(${driveImager(tour['Drive id gambar utama'])})`}
              ></div>
              <div class="card-content">
                <h4 class="card-title">{tour['Judul']}</h4>
                <p class="card-desc">{tour['Deskripsi Singkat']}</p>
                <div class="card-details">
                  <span class="card-price">{formatRupiah(tour['Harga'])}</span>
                  <span class="card-distance">{tour['Jarak Sepeda (km)']} km</span>
                </div>
                <button type="button" class="card-button">Lihat Detail</button>
              </div>
            </div>
          ))}
        </div>

        <div class="tour-expanded-wrapper" id="tour-expanded-wrapper">
          {tours.map((tour: any, i: number) => (
            <article class="tour-card-expanded" data-tour-index={i} id={`expanded-${i}`}>
              <button type="button" class="tour-expanded-close" aria-label="Tutup">×</button>
              <div
                class="tour-card-expanded-image"
                style={`background-image: url(${driveImager(tour['Drive id gambar utama'])})`}
              ></div>
              <div class="tour-card-expanded-body">
                <h2 class="tour-card-expanded-title">{tour['Judul']}</h2>
                <p class="tour-card-expanded-desc">{tour['Deskripsi Singkat']}</p>
                <p class="tour-card-expanded-desc">{tour['Deskripsi Penuh']}</p>
                <div class="tour-card-expanded-meta">
                  <span>{tour['Jarak Sepeda (km)']} km</span>
                  <span>{tour['Durasi Minimal (Jam)']}–{tour['Durasi Maksimal (Jam)']} jam</span>
                  <span class="tour-card-expanded-price">{formatRupiah(tour['Harga'])}</span>
                </div>
                <div class="orders-contact">
                  <a class="waContactButton" href="https://wa.me/6287788877925">Pesan melalui WhatsApp</a>
                  <span>atau kontak +62 877-8887-7925</span>
                </div>
              </div>
            </article>
          ))}
        </div>
      </div>
    </section>
    <Footer />

    <script>
      (function () {
        const wrapper = document.getElementById('tour-expanded-wrapper');
        const expandedCards = wrapper?.querySelectorAll('.tour-card-expanded');
        const scrollCards = document.querySelectorAll('.tour-section .tour-card');

        function setExpanded(index: number | null) {
          if (index == null || index < 0) {
            wrapper?.classList.remove('has-expanded');
            expandedCards?.forEach((el, i) => {
              el.classList.toggle('is-visible', false);
            });
            return;
          }
          wrapper?.classList.add('has-expanded');
          expandedCards?.forEach((el, i) => {
            el.classList.toggle('is-visible', i === index);
          });
        }

        function getIndexFromCard(card: Element) {
          const idx = card.getAttribute('data-tour-index');
          return idx == null ? -1 : parseInt(idx, 10);
        }

        scrollCards?.forEach((card: Element) => {
          const index = getIndexFromCard(card);
          card.addEventListener('click', (e: Event) => {
            const target = (e.target as Element | null);
            if (target?.closest?.('.card-button') || e.currentTarget === card) {
              const current = wrapper?.querySelector('.tour-card-expanded.is-visible');
              const currentIndex = current ? getIndexFromCard(current) : -1;
              setExpanded(currentIndex === index ? null : index);
            }
          });
        });

        wrapper?.querySelectorAll('.tour-expanded-close').forEach((btn) => {
          btn.addEventListener('click', () => setExpanded(null));
        });

        expandedCards?.forEach((el) => {
          el.addEventListener('click', (e: Event) => {
            const target = e.target as Element | null;
            if (target?.closest?.('.tour-expanded-close')) return;
            const currentIndex = getIndexFromCard(el);
            const visible = wrapper?.querySelector('.tour-card-expanded.is-visible');
            if (visible && getIndexFromCard(visible) === currentIndex) setExpanded(null);
          });
        });
      })();
    </script>
  </body>
</html>

<style>
  .waContactButton {
    padding: 0.7em;
    background-color: #075e54;
    color: white;
    font-weight: bold;
    border-radius: 2em;
    text-decoration: none;
  }

  .orders-contact {
    display: flex;
    flex-wrap: wrap;
    flex-direction: row;
    padding: 1em 0;
    gap: 1em;
    align-items: center;
  }

  .tours-page {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    background-color: var(--dry-sage);
  }

  .tours-header{
    background-color: var(--hunter-green);
    padding: 3em;
  }

  .tours-header h2 {
    font-family: 'Playfair Display Variable', serif;
    color: var(--dry-sage);
    margin-bottom: 0.5rem;
  }

  .tours-header p {
    color: var(--ocean-pearl);
  }

  /* Scroll section (like index) */
  .tour-section {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    overflow: hidden;
  }

  .tour-section-title {
    color: var(--deep-mocha);
    font-family: 'Playfair Display Variable', serif;
    text-align: center;
    margin: 0 0 0.5rem 0;
  }

  .tour-scroll-container {
    display: flex;
    gap: 2em;
    overflow-x: auto;
    width: fit-content;
    max-width: 100%;
    margin: 0 auto;
    padding: 1em 2em;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }

  .tour-scroll-container::-webkit-scrollbar {
    display: none;
  }

  .tour-card {
    flex: 0 0 300px;
    scroll-snap-align: center;
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
    height: 480px;
    cursor: pointer;
  }

  .tour-card:hover {
    transform: translateY(-5px);
  }

  .tour-card .card-image {
    height: 180px;
    flex-shrink: 0;
    background-size: cover;
    background-position: center;
  }

  .tour-card .card-content {
    padding: 1.5em;
    display: flex;
    flex-direction: column;
    flex-grow: 1;
  }

  .tour-card .card-title {
    font-family: 'Playfair Display Variable', serif;
    color: var(--hunter-green);
    font-size: 1.2rem;
    font-weight: 700;
    margin: 0 0 0.5em 0;
  }

  .tour-card .card-desc {
    font-size: 0.9rem;
    color: #555;
    line-height: 1.4;
    margin-bottom: auto;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .tour-card .card-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1em;
    padding-top: 1em;
    border-top: 1px solid #eee;
    font-size: 0.9rem;
  }

  .tour-card .card-price {
    font-weight: bold;
    color: var(--deep-mocha);
  }

  .tour-card .card-distance {
    color: #888;
    font-size: 0.85rem;
  }

  .tour-card .card-button {
    margin-top: 1em;
    padding: 0.8em;
    background-color: var(--hunter-green);
    color: var(--dry-sage);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.2s;
    width: 100%;
  }

  .tour-card .card-button:hover {
    background-color: var(--deep-mocha);
    color: white;
  }

  /* Expanded full-span card (below scroll) */
  .tour-expanded-wrapper {
    display: none;
    padding: 0 2em 2em;
  }

  .tour-expanded-wrapper.has-expanded {
    display: block;
  }

  .tour-card-expanded {
    display: none;
    width: 100%;
    background: #fff;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    position: relative;
    flex-direction: row;
  }

  .tour-card-expanded.is-visible {
    display: flex;
  }

  .tour-expanded-close {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    z-index: 2;
    width: 2.25rem;
    height: 2.25rem;
    border: none;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.5);
    color: #fff;
    font-size: 1.5rem;
    line-height: 1;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }

  .tour-expanded-close:hover {
    background: rgba(0, 0, 0, 0.7);
  }

  .tour-card-expanded-image {
    width: 40%;
    min-height: 260px;
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
  }

  .tour-card-expanded-body {
    flex: 1;
    padding: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .tour-card-expanded-title {
    font-family: 'Playfair Display Variable', serif;
    color: var(--hunter-green);
    margin: 0;
  }

  .tour-card-expanded-desc {
    color: #555;
    margin: 0;
    line-height: 1.5;
  }

  .tour-card-expanded-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    font-weight: 600;
  }

  .tour-card-expanded-price {
    color: var(--deep-mocha);
  }

  @media (max-width: 900px) {
    .tour-card-expanded {
      flex-direction: column;
    }

    .tour-card-expanded-image {
      width: 100%;
      min-height: 200px;
    }
  }
</style>