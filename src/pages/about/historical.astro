---
import AboutLayout from '../../layouts/AboutLayout.astro';

import ponjongMap from '../../assets/petaSejarah.svg';

import Papa from 'papaparse';
// 1. Fetch the data at build time
const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSueJxrlH6WKPNcw8xsvlvgWYnv-qUB6fXnViiZcCS4UfYU1HoI-VagXnv6Tu-5_07OmsTdO8MIsrGo/pub?gid=1046898832&single=true&output=csv');
const csvText = await response.text();

// 2. Parse CSV to JSON
// header: true uses the first row as keys
const { data: allLocations } = Papa.parse(csvText, { header: true });
const locations = allLocations.filter((loc) => loc.kategori === 'sejarah');

const driveImager = (file_id: string) => {
  return 'https://lh3.googleusercontent.com/u/0/d/'+file_id+'=w2000'
}
---

<AboutLayout title="Pesona Kehidupan Ponjong">
  <section class="nature-page">
    <header class="nature-header">
      <h1>Pesona Kehidupan Ponjong</h1>
      <p>Klik pin di peta untuk menjelajahi destinasi alam di kawasan Ponjong.</p>
    </header>

    <div class="map-layout">
      <div class="map-container" id="nature-map">
        <!-- Abstract map surface (replace with real map image if you have one) -->
        <div class="map-surface" aria-hidden="true">
          <img style="object-fit: fill;" src={ponjongMap.src}/>
        </div>

        {locations.map((loc, index) => (
          <button
            type="button"
            class="map-pin"
            data-location-id={index} 
            style={`left: ${loc.map_x}%; top: ${loc.map_y}%;`}
            aria-label={`Lokasi: ${loc.Nama}`}
            title={loc.Nama}
          >
            <span class="map-pin-dot"></span>
          </button>
        ))}
      </div>

      <aside class="map-detail-panel" id="detail-panel">
        <div class="map-detail-placeholder" id="detail-placeholder">
          <span class="map-detail-hint">Pilih sebuah lokasi di peta</span>
        </div>
        <div class="map-detail-content hidden" id="detail-content">
          <button type="button" class="map-detail-close" id="detail-close" aria-label="Tutup">Ã—</button>
          <h2 class="map-detail-title" id="detail-title"></h2>
          <p class="map-detail-desc" id="detail-desc"></p>
        </div>
      </aside>
    </div>
  </section>

  <script lang="ts" define:vars={{ locations }}>
    (function () {
      const panel = document.getElementById('detail-panel');
      const placeholder = document.getElementById('detail-placeholder');
      const content = document.getElementById('detail-content');
      const titleEl = document.getElementById('detail-title');
      const descEl = document.getElementById('detail-desc');
      const closeBtn = document.getElementById('detail-close');
  
      const pins = document.querySelectorAll('.map-pin');
      const data = Array.isArray(locations) ? locations : [];
  
      function showDetail(indexStr) {
        // CONVERT STRING ID TO NUMBER
        const index = parseInt(indexStr, 10);
        
        // ACCESS DIRECTLY BY INDEX
        const loc = data[index]; 
  
        if (!loc || !titleEl || !descEl || !placeholder || !content) return;
        
        placeholder.classList.add('hidden');
        content.classList.remove('hidden');
        titleEl.textContent = loc.Nama;
        descEl.textContent = loc.Deskripsi; // Ensure your CSV has a 'description' column
        
        pins.forEach((pin) => {
          // Compare the attribute string vs the current index string
          pin.classList.toggle('is-active', pin.getAttribute('data-location-id') === indexStr);
        });
      }
  
      function hideDetail() {
        placeholder?.classList.remove('hidden');
        content?.classList.add('hidden');
        pins.forEach((p) => p.classList.remove('is-active'));
      }
  
      pins.forEach((pin) => {
        pin.addEventListener('click', () => {
          // This will now get "0", "1", etc.
          const id = pin.getAttribute('data-location-id'); 
          if (id === null) return;
          
          // Helper to check if currently active
          const isActive = pin.classList.contains('is-active');
  
          if (!isActive) showDetail(id);
          else hideDetail();
        });
      });
  
      closeBtn?.addEventListener('click', hideDetail);
    })();
  </script>
</AboutLayout>

<style>
  .nature-page {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .nature-header h1 {
    font-family: 'Playfair Display Variable', serif;
    color: var(--dark-spruce);
    margin-bottom: 0.25rem;
  }

  .nature-header p {
    color: var(--dark-spruce);
    margin: 0;
  }

  .map-layout {
    display: grid;
    grid-template-columns: 1fr 700px;
    gap: 1.5rem;
    align-items: start;
  }

  .map-container {
    position: relative;
    height: auto;
    border-radius: 16px;
    overflow: hidden;
    background: #fff;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  }

  .map-surface {
    position: relative;
    width: 100%;
    pointer-events: none;
  }

  .map-surface img {
    display: block;
    width: 100%;
    height: auto;
  }

  .map-pin {
    position: absolute;
    transform: translate(-50%, -50%);
    width: 36px;
    height: 36px;
    padding: 0;
    border: none;
    border-radius: 50%;
    background: transparent;
    cursor: pointer;
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease;
  }

  .map-pin:hover,
  .map-pin.is-active {
    transform: translate(-50%, -50%) scale(1.2);
  }

  .map-pin-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--dry-sage);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.35);
    border: 3px solid #fff;
    transition: background 0.2s, box-shadow 0.2s;
  }

  .map-pin:hover .map-pin-dot,
  .map-pin.is-active .map-pin-dot {
    background: #fff;
    box-shadow: 0 0 0 4px var(--hunter-green);
  }

  .map-detail-panel {
    position: sticky;
    top: 1rem;
    min-height: 200px;
    height: 80%;
    border-radius: 12px;
    background: #fff;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    padding: 1.25rem;
    border: 1px solid rgba(0, 0, 0, 0.06);
  }

  .map-detail-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 180px;
    color: var(--gray);
  }

  .map-detail-hint {
    font-size: 0.95rem;
    color: #888;
  }

  .map-detail-content {
    position: relative;
  }

  .map-detail-content.hidden {
    display: none !important;
  }

  .map-detail-close {
    position: absolute;
    top: -0.25rem;
    right: 0;
    width: 28px;
    height: 28px;
    border: none;
    border-radius: 50%;
    background: #eee;
    color: #555;
    font-size: 1.25rem;
    line-height: 1;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, color 0.2s;
  }

  .map-detail-close:hover {
    background: var(--hunter-green);
    color: var(--dry-sage);
  }

  .map-detail-title {
    font-family: 'Playfair Display Variable', serif;
    color: var(--hunter-green);
    font-size: 1.35rem;
    margin: 0 0 0.75rem 0;
    padding-right: 2rem;
  }

  .map-detail-desc {
    color: #444;
    line-height: 1.55;
    margin: 0;
    font-size: 0.95rem;
  }

  .hidden {
    display: none !important;
  }

  @media (max-width: 900px) {
    .map-layout {
      grid-template-columns: 1fr;
    }

    .map-detail-panel {
      position: static;
    }
  }
</style>
